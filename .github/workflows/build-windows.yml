name: Build (Windows)
on:
  workflow_call:
    inputs:
      GTAF_FULL_VERSION:
        required: true
        type: string
      BUILD_TYPE:
        required: true
        type: string

jobs:
  build-windows:
    name: Build Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # IMPORTANT: Ensure MSVC environment is loaded
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # Optional but recommended: show compiler to fail fast if wrong
      - name: Verify compiler
        run: |
          cl
          where cl
          where gcc || echo "gcc not found (good)"

      - name: Configure (MSVC)
        run: >
          cmake -S ./src -B build
          -G "Visual Studio 17 2022"
          -A x64
          -DCMAKE_BUILD_TYPE=${{ inputs.BUILD_TYPE }}
          -DGTAF_FULL_VERSION=${{ inputs.GTAF_FULL_VERSION }}

      - name: Build
        run: >
          cmake --build build
          --config ${{ inputs.BUILD_TYPE }}
          --parallel

      - name: Package artifacts
        run: |
          mkdir dist
          copy build\${{ inputs.BUILD_TYPE }}\*.* dist\
        shell: pwsh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gtaf-windows-${{ inputs.GTAF_FULL_VERSION }}
          path: dist

